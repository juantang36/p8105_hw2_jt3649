---
title: "p8105_hw2_jt3649"
author: "Juan Tang"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup}
library(tidyverse)
library(readxl)
```


## Problem 1
Import datasets. 

Read in and clean the pols-month dataset and clean the names. 
```{r}
pols_month_df = 
  read_csv("data/pols-month.csv")
pols_month_df = 
  #use clean_name function in the janitor package
  janitor::clean_names(pols_month_df) |>
  #use separate() to break up the variable mon. 
  separate(mon, into = c("year", "month", "day"), sep = "-") |>
  mutate(
    #change the month number to name
    month = as.numeric(month),
    month = month.name[month], 
    #convert year avriable to numeric value
    year = as.numeric(year),
    #add president variable
    president = ifelse(prez_gop == 1, "gop", "dem")
  ) |>
  #remove prez_dem, prez_gop, day variable
  select(-prez_dem, -prez_gop, -day) |>
  #arrange the year, month order
  arrange(year, month)
```

Read in and clean the snp dataset and clean the names. 
```{r}
snp_df = 
  read_csv("data/snp.csv")
snp_df = 
  #use clean_name function in the janitor package
  janitor::clean_names(snp_df) |>
  #use separate() to break up the variable mon. 
  separate(date, into = c("month", "day", "year"), sep = "/") |>
  mutate(
    #change the month number to name
    month = as.numeric(month),
    month = month.name[month],
    #change the year variable to numeric number
    year = as.numeric(year), 
    #unify the year variable format 
    year = ifelse(year < 50, year + 2000, year + 1900)
    ) |>
  #remove day variable
  select(-day) |>
  #arrange the year, month order
  arrange(year, month)
```

Read in and clean the unemployment dataset
```{r}
unemployment_df = 
  read_csv("data/unemployment.csv") |>
  pivot_longer(
    #select all columns except "Year" to pivot
    cols = -Year, 
    #put the columns names into a new column "month"
    names_to = "month", 
    #put the unemployment_rate values into a new column "unemployment_rate"
    values_to = "unemployment_rate"
  ) |>
  mutate(
    #match the month abbreviation with month name
    month = month.name[match(month, month.abb)], 
    #match the column name year
    year = Year
  ) |>
  select(year, month, unemployment_rate) |>
  #arrange the year, month variable in order
  arrange(year, month)
```

Merge the datasets
```{r}
merged_data = pols_month_df |>
  #merge snp into pols
  left_join(snp_df, by = c("year", "month")) |>
  #merge unemployment into pols and snp dataset
  left_join(unemployment_df, by = c("year", "month"))
```

This is the merged dataset: 
```{r}
print(merged_data)
```

Description of the dataset
Explain briefly what each dataset contained, and describe the resulting dataset (e.g. give the dimension, range of years, and names of key variables).



## Problem 2
Read and clean the Mr. Trash Wheel data sheet
```{r mr trash wheel}
mr_trash_wheel_df = 
  read_excel("data/202409 Trash Wheel Collection Data.xlsx",
             sheet = "Mr. Trash Wheel", 
             #include only columns with data
             range = cell_cols("A:N"), 
             #skip the first row which contains a figure
             skip = 1
             ) |>
  janitor::clean_names() |>
  #remove rows without dumpster data
  filter(!is.na(dumpster)) |>
  mutate(
    #round the number of sports balls to the nearest integer
    sports_balls = as.integer(round(sports_balls, 0)), 
    year = as.numeric(year),
    #add identifier variable
    trash_wheel = "Mr. Trash Wheel"
  )
#number of observations in the mr_trash_wheel dataset
cat("Mr. Trash Wheel observations: ", nrow(mr_trash_wheel_df))
```

Read and clean the Professor Trash Wheel data sheet 
```{r prof trash wheel}
prof_trash_wheel_df = 
  read_excel("data/202409 Trash Wheel Collection Data.xlsx",
             sheet = "Professor Trash Wheel", 
             #include only columns with data
             range = cell_cols("A:M"), 
             #skip the first row which contains a figure
             skip = 1
             ) |>
  janitor::clean_names() |>
  #remove rows without dumpster data
  filter(!is.na(dumpster)) |>
  mutate(
    #there is no sports_ball variable in the sheet
    sports_balls = NA_integer_, 
    #unify date formate
    date = as.Date(date),
    year = as.numeric(year),
    #add identifier variable
    trash_wheel = "Professor Trash Wheel"
  )
#number of observations in the prof_trash_wheel dataset
cat("Professor Trash Wheel observations: ", nrow(prof_trash_wheel_df))
```

Read and clean the gwynnda trash wheel data sheet 
```{r gwynnda}
gwynnda_trash_wheel_df = 
  read_excel("data/202409 Trash Wheel Collection Data.xlsx",
             sheet = "Gwynnda Trash Wheel", 
             #include only columns with data
             range = cell_cols("A:L"), 
             #skip the first row which contains a figure
             skip = 1
             ) |>
  janitor::clean_names() |>
  #remove rows without dumpster data
  filter(!is.na(dumpster)) |>
  mutate(
    #there is no sports_ball variable in the sheet
    sports_balls = NA_integer_, 
    date = as.Date(date),
    year = as.numeric(year),
    #add identifier variable
    trash_wheel = "Gwynnda Trash Wheel"
  )
#number of observations in the gwynnda_trash_wheel dataset
cat("Gwynnda Trash Wheel observations: ", nrow(gwynnda_trash_wheel_df))
```

Combine datasets
```{r combine datasets}
combined_trash_wheel = bind_rows(mr_trash_wheel_df, prof_trash_wheel_df, gwynnda_trash_wheel_df) |>
  arrange(trash_wheel, date)
```

Dataset summary

The combined dataset has `r nrow(combined_trash_wheel)` observations. Example variables include `r paste(names(combined_trash_wheel), collapse = ", ")`.

Total weight of trash collected by Professor Trash Wheel
```{r professor weight}
prof_total_weight = combined_trash_wheel |>
  filter(trash_wheel == "Professor Trash Wheel") |>
  summarise(total_weight = sum(weight_tons, na.rm = TRUE)) |>
  pull(total_weight)
prof_total_weight
```
Total weight of trash collected by Professor Trash Wheel is `r prof_total_weight` tons. 

Cigarette Butts Collected by Gwynnda in June 2022
```{r}
gwynnda_cigarette_june_2022 = combined_trash_wheel |>
  filter(
    trash_wheel == "Gwynnda Trash Wheel", 
    year(date) == 2022, 
    month(date) == 6
  ) |>
  summarize(total_cig = sum(cigarette_butts, na.rm = TRUE)) |>
  pull(total_cig)
gwynnda_cigarette_june_2022
```
Cigarette Butts Collected by Gwynnda in June 2022 are `r gwynnda_cigarette_june_2022`. 


## Problem 3
Import and clean data
```{r}
#Import rental price data
rental_price_df = read_csv("data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  janitor::clean_names()
#Import zip code data
zip_code_df = read_csv("data/zillow_data/Zip Codes.csv") |>
  janitor::clean_names()
```

Tidy rental price dataset
```{r rental price tidy}
#The data is in wide format with dates as columns. Pivot it to long format. 
rental_price_tidy = rental_price_df |>
  pivot_longer(
    #"\\d{4}" means matches exactly 4 digits (year)
    #"\\d{2}" means matches exactly 2 digits (month/day)
    col = starts_with("x") | matches ("^\\d{4}_\\d{2}_\\d{2}$"), 
    #set the name of the variable(column) to "date"
    names_to = "date", 
    #add "price" variable
    values_to = "price"
  ) |>
  #tidy the "date" variable
  mutate(
    #remove "x" prefix before the date
    date = str_remove(date, "x"), 
    #replace "_" with "-"
    date = str_replace_all(date, "_", "-"), 
    date = as.Date(date)
  ) |>
    #remove rows with missing prices
  filter(!is.na(price)) |>
  #standardize the county names in rental_price
  mutate(
    county_name = str_remove(county_name, "County$"), 
    county_name = case_when(
      county_name == "New York" ~ "New York", 
      county_name == "Kings" ~ "Kings", 
      county_name == "Queens" ~ "Queens", 
      county_name == "Bronx" ~ "Bronx", 
      county_name == "Richmond" ~ "Richmond", 
      TRUE ~ county_name
      )
  )
```

Tidy zip code dataset
```{r zip code tidy}
zip_code_tidy = zip_code_df |>
  mutate(
    #add a borough column from county
    borough = case_when(
      str_detect(county, "New York") ~ "Manhattan", 
      str_detect(county, "Kings") ~ "Brooklyn", 
      str_detect(county, "Queens") ~ "Queens",
      str_detect(county, "Bronx") ~ "Bronx", 
      str_detect(county, "Richmond") ~ "Staten Island", 
      TRUE ~ NA_character_
    ), 
    #unify the county names in zip_code_tidy
    county = case_when(
      str_detect(county, "New York") ~ "New York", 
      str_detect(county, "Kings") ~ "Kings", 
      str_detect(county, "Queens") ~ "Queens",
      str_detect(county, "Bronx") ~ "Bronx", 
      str_detect(county, "Richmond") ~ "Richmond", 
      TRUE ~ county
      )
  )
```

Check for repeated data
```{r}
#repeated data in zip_code_tidy
cat("Check for zip_code redundant data: ")
zip_code_tidy |>
  count(zip_code) |>
  filter(n > 1) |>
  print()
#repeated data in rental_price_tidy
cat("Check for zip_code redundant data: ")
rental_price_tidy |>
  count(region_name, date) |>
  filter(n > 1) |>
  print()
```

remove repeated data
```{r}
#Remove repeated data in zip_code
zip_code_tidy_unique = zip_code_tidy |>
  distinct(zip_code, .keep_all = TRUE)

#there is no repeated data in rental_price_tidy
rental_price_tidy_unique = rental_price_tidy
```


Merge datasets
```{r merge_data}
#merge datasets by zip code
merged_data = rental_price_tidy_unique |>
  left_join(
    zip_code_tidy_unique, 
    by = c("region_name" = "zip_code")
  ) |>
  #organize columns in order, include only important variables
  select(
    zip_code = region_name, 
    borough, 
    neighborhood, 
    county = county_name, 
    date, 
    price
  ) |>
  #arrange by borough, neighborhood, zip code, and date
  arrange(borough, neighborhood, zip_code, date)
merged_data
```

Dataset summary

